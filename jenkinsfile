// Jenkinsfile â€” Buildah + Python
// - íƒœê·¸ ì •ì±…: ìˆœìˆ˜ semver(X.Y.Z) + latest
// - ì˜µì…˜: PUSH_IMMUTABLE=true ë¡œ ë‘ë©´ X.Y.Z-<sha>ë„ í•¨ê»˜ í‘¸ì‹œ
// - Argo CD Image UpdaterëŠ” allow-tags=regexp:^\\d+\\.\\d+\\.\\d+$ ì™€ ì°°ë–¡ê¶í•©
// - Git íƒœê·¸ëŠ” ì‚¬ìš©í•˜ì§€ ì•Šê³ , Docker Hub ë ˆì§€ìŠ¤íŠ¸ë¦¬ì˜ ê¸°ì¡´ íƒœê·¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë²„ì „ì„ ì˜¬ë¦½ë‹ˆë‹¤.

pipeline {
  agent {
    kubernetes {
      yaml '''
apiVersion: v1
kind: Pod
metadata:
  labels:
    jenkins: "agent"
spec:
  restartPolicy: Never
  nodeSelector:
    kubernetes.io/os: linux
  securityContext:
    runAsUser: 0
  volumes:
    - name: workspace-volume
      emptyDir: {}
  containers:
    - name: buildah
      image: quay.io/buildah/stable:v1.34.0
      securityContext:
        privileged: true
      env:
        - name: STORAGE_DRIVER
          value: vfs
        - name: BUILDAH_ISOLATION
          value: chroot
      command: ['cat']
      tty: true
      volumeMounts:
        - name: workspace-volume
          mountPath: /home/jenkins/agent

    - name: python
      image: python:3.11-slim
      command: ['cat']
      tty: true
      volumeMounts:
        - name: workspace-volume
          mountPath: /home/jenkins/agent

    - name: git
      image: alpine/git:2.45.2
      command: ['cat']
      tty: true
      volumeMounts:
        - name: workspace-volume
          mountPath: /home/jenkins/agent

    - name: jnlp
      image: jenkins/inbound-agent:3327.v868139a_d00e0-6
      env:
        - name: JENKINS_AGENT_WORKDIR
          value: /home/jenkins/agent
      volumeMounts:
        - name: workspace-volume
          mountPath: /home/jenkins/agent
'''
    }
  }

  triggers { githubPush() }

  options {
    disableConcurrentBuilds()
    skipDefaultCheckout(true)
  }

  parameters {
    choice(name: 'BUMP', choices: ['patch', 'minor', 'major'], description: 'ë„ì»¤ ë ˆí¬ ê¸°ì¤€ìœ¼ë¡œ ì˜¬ë¦´ ë²„ì „ ì¢…ë¥˜')
  }

  environment {
    IMAGE_BASE     = 'docker.io/sessaczump/zump-api-amd64'
    REGISTRY       = 'docker.io'
    // ë¶ˆë³€ íƒœê·¸(X.Y.Z-<sha>)ë„ í‘¸ì‹œí•˜ë ¤ë©´ true
    PUSH_IMMUTABLE = 'false'
  }

  stages {

    stage('Checkout') {
      steps {
        checkout(scm)
        container('git') {
          sh '''
            set -euxo pipefail
            git fetch --tags --force || true
          '''
        }
      }
    }

    // ğŸ” Docker Hub ë ˆí¬ì˜ íƒœê·¸ ëª©ë¡ì„ ì½ì–´ ë‹¤ìŒ semverë¥¼ ê³„ì‚°
    stage('Resolve Version from Registry (semver bump)') {
      steps {
        container('python') {
          script {
            def nextVer = sh(
              label: 'Compute next semver from Docker Hub',
              returnStdout: true,
              script: '''
                set -euo pipefail

                IMAGE_BASE="${IMAGE_BASE}"
                REPO="${IMAGE_BASE#docker.io/}"  # ex) sessaczump/zump-api-amd64
                NS="${REPO%%/*}"
                NAME="${REPO#*/}"
                BUMP_KIND="${BUMP:-patch}"

                python3 - <<'PY'
import os, sys, json, urllib.request, urllib.error, re

ns   = os.environ["NS"]
name = os.environ["NAME"]
bump = os.environ.get("BUMP_KIND","patch").lower()

SEMVER = re.compile(r"^(\\d+)\\.(\\d+)\\.(\\d+)$")

def fetch_all_tags():
    tags = []
    url = f"https://hub.docker.com/v2/repositories/{ns}/{name}/tags?page_size=100&ordering=last_updated"
    while url:
        try:
            with urllib.request.urlopen(url, timeout=15) as r:
                data = json.load(r)
        except Exception as e:
            # ê³µê°œ ë ˆí¬ê°€ ì•„ë‹ ìˆ˜ ìˆìŒ â€” ê¸°ë³¸ ì‹œì‘ ë²„ì „ìœ¼ë¡œ ì§„í–‰
            print("1.0.0")
            return None
        for it in data.get("results", []):
            t = it.get("name")
            if isinstance(t, str):
                tags.append(t)
        url = data.get("next")
    return tags

def max_semver(tags):
    good = []
    for t in tags:
        m = SEMVER.match(t)
        if m:
            good.append(tuple(map(int, m.groups())))
    if not good:
        return (1,0,0)  # ì´ˆê¸° ì‹œì‘ê°’
    return max(good)

tags = fetch_all_tags()
if tags is None:
    # API ì‹¤íŒ¨ ì‹œ ì•ˆì „í•˜ê²Œ ì´ˆê¸°ê°’ ì‚¬ìš©
    base = (1,0,0)
else:
    base = max_semver(tags)

major, minor, patch = base

if bump == "patch":
    patch += 1
elif bump == "minor":
    minor += 1; patch = 0
elif bump == "major":
    major += 1; minor = 0; patch = 0
else:
    patch += 1

candidate = f"{major}.{minor}.{patch}"

# ì´ë¯¸ ì¡´ì¬í•˜ë©´ patchë¥¼ ì˜¬ë¦¬ë©° ë¹„ì–´ìˆëŠ” ìŠ¬ë¡¯ì„ íƒìƒ‰
if tags:
    used = set(t for t in tags if SEMVER.match(t))
    cmaj, cmin, cpat = major, minor, patch
    while candidate in used:
        cpat += 1
        candidate = f"{cmaj}.{cmin}.{cpat}"

print(candidate)
PY
              '''
            ).trim()

            def sha = sh(script: "git rev-parse --short HEAD || echo nolocalgit", returnStdout: true).trim()

            env.VERSION         = nextVer                      // X.Y.Z
            env.GIT_SHA         = sha
            env.IMAGE_VERSION   = "${env.IMAGE_BASE}:${env.VERSION}"
            env.IMAGE_LATEST    = "${env.IMAGE_BASE}:latest"
            env.IMAGE_IMMUTABLE = "${env.IMAGE_BASE}:${env.VERSION}-${env.GIT_SHA}"

            echo "âœ” Next version from registry: ${env.VERSION} (bump=${params.BUMP})"
          }
        }
      }
    }

    stage('Python: deps & quick checks') {
      steps {
        container('python') {
          sh '''
            set -euxo pipefail
            python -V
            python -m venv .venv
            . .venv/bin/activate
            pip install --upgrade pip
            if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

            if [ -f main.py ]; then python -m py_compile main.py; fi
            find . -name "*.py" -print0 | xargs -0 -I{} python -m py_compile "{}" || true

            if [ -f tests/test_build_validation.py ]; then python -m pytest tests/test_build_validation.py -v --tb=short; fi
            echo "âœ” Python checks passed"
          '''
        }
      }
    }

    stage('Registry login') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'REG_USERNAME', passwordVariable: 'REG_PASSWORD')]) {
          container('buildah') {
            sh '''
              set -euxo pipefail
              echo "$REG_PASSWORD" | buildah login --username "$REG_USERNAME" --password-stdin docker.io
            '''
          }
        }
      }
    }

    stage('Build image (Buildah)') {
      steps {
        container('buildah') {
          sh '''
            set -euxo pipefail
            buildah version || true
            buildah info || true

            echo "ğŸ”¨ Build ${IMAGE_VERSION}"
            buildah bud --format docker -f Dockerfile -t "${IMAGE_VERSION}" .

            buildah tag "${IMAGE_VERSION}" "${IMAGE_LATEST}"

            if [ "${PUSH_IMMUTABLE}" = "true" ]; then
              buildah tag "${IMAGE_VERSION}" "${IMAGE_IMMUTABLE}"
            fi

            echo "âœ” Built images:"
            buildah images | grep -E "${IMAGE_BASE}" || true
          '''
        }
      }
    }

    stage('Push images') {
      steps {
        container('buildah') {
          sh '''
            set -euxo pipefail

            # ì¡´ì¬ ì—¬ë¶€ë¥¼ í•œ ë²ˆ ë” í™•ì¸(í¬ë°•í•˜ì§€ë§Œ ê²½ìŸìƒí™© ë°©ì§€)
            # Docker Hub APIì—ì„œ ë°©ê¸ˆ ê³„ì‚°í•œ VERSIONì´ ì´ë¯¸ ìƒê²¼ë‹¤ë©´ ì‹¤íŒ¨ ì²˜ë¦¬í•˜ê±°ë‚˜ patch++ ë¡œì§ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            for TAG in "${IMAGE_VERSION}" "${IMAGE_LATEST}"; do
              echo "ğŸ“¤ Pushing $TAG"
              buildah push "$TAG"
            done

            if [ "${PUSH_IMMUTABLE}" = "true" ]; then
              echo "ğŸ“¤ Pushing ${IMAGE_IMMUTABLE}"
              buildah push "${IMAGE_IMMUTABLE}"
            fi
          '''
        }
      }
    }
  }

  post {
    success {
      echo 'âœ… ë¹Œë“œ/í‘¸ì‹œ ì„±ê³µ â€” Docker Hub ê¸°ì¤€ semver ìë™ ìƒìŠ¹ ì™„ë£Œ. AIUê°€ ^\\d+\\.\\d+\\.\\d+$ ìµœì‹  íƒœê·¸ë¥¼ ê°ì§€í•©ë‹ˆë‹¤.'
    }
    failure {
      echo 'âŒ ë¹Œë“œ ì‹¤íŒ¨ â€” ì½˜ì†” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.'
    }
    always {
      container('buildah') {
        sh '''
          set +e
          buildah logout ${REGISTRY} || true
          buildah rmi -f "${IMAGE_VERSION}" "${IMAGE_LATEST}" "${IMAGE_IMMUTABLE}" 2>/dev/null || true
        '''
      }
      container('python') {
        sh 'rm -rf .venv || true'
      }
    }
  }
}
